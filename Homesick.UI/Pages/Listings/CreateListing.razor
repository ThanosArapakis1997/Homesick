@page "/listing/create"
@inject IStreamService StreamService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<MudForm @ref="form">
    <MudGrid>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4">
                <MudProgressCircular Value="progress" Color="Color.Primary" />
                <MudText Typo="Typo.h6">@progress% έχει ολοκληρωθεί</MudText>
                <MudText Typo="Typo.body1">Νέα Αγγελία</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="9">
            <MudPaper Style="width: 1300px">
                <MudStepper @bind-ActiveIndex="_index" ShowResetButton="true">
                    <ChildContent>
                        <MudStep Title="Κατηγορία Ακινήτου" SecondaryText="Κατοικία, Διαμέρισμα, Ενοικίαση" Skippable="false" CompletedChanged="AfterStep1">
                            <MudPaper Class="pa-4">
                                    <MudText Typo="Typo.button">Κατηγορία Ακινήτου</MudText>
                                    <MudRadioGroup T="string" @bind-Value="model.PropertyType">
                                        <MudRadio T="string" Value="@SD.PropertyTypeHouse">Κατοικία</MudRadio>
                                        <MudRadio T="string" Value="@SD.PropertyTypeLand">Γη</MudRadio>
                                    </MudRadioGroup>

                                    @if (model.PropertyType == @SD.PropertyTypeHouse)
                                    {
                                        <MudText Typo="Typo.button">Eίδος του ακινήτου</MudText>
                                        <MudSelect T="string" @bind-Value="model.HouseType">
                                            <MudSelectItem T="string" Value="@SD.HouseTypeFlat">Διαμέρισμα</MudSelectItem>
                                            <MudSelectItem T="string" Value="@SD.HouseTypeStudio">Studio/Γκαρσονιέρα</MudSelectItem>
                                            <MudSelectItem T="string" Value="@SD.HouseTypeMaisonette">Μεζονέτα</MudSelectItem>
                                            <MudSelectItem T="string" Value="@SD.HouseTypeVilla">Βίλλα</MudSelectItem>
                                            <MudSelectItem T="string" Value="@SD.HouseTypeLoft">Loft</MudSelectItem>
                                        </MudSelect>
                                    }
                                    <br />
                                    <br />
                                    <MudText Typo="Typo.button">Διατίθεται προς</MudText>
                                    <MudRadioGroup T="string" @bind-value="listing.ListingType">
                                        <MudRadio T="string" Value="@SD.ListingTypeBuy">Πώληση</MudRadio>
                                        <MudRadio T="string" Value="@SD.ListingTypeRent">Ενοικίαση</MudRadio>
                                    </MudRadioGroup>

                            </MudPaper>
                        </MudStep>
                        <MudStep Title="Τοποθεσία" SecondaryText="Διεύθυνση Κατοικίας" Skippable="false" CompletedChanged="@(()=> progress = 40)">
                            <MudPaper Class="pa-4">
                                    <MudText Typo="Typo.button">Πόλη</MudText>
                                    <MudTextField Variant="Variant.Text" Placeholder="Πόλη" @bind-Value="model.City" />
                                    <br />
                                    <MudText Typo="Typo.button">Περιοχή</MudText>
                                    <MudAutocomplete @bind-Value="model.Area"
                                                 SearchFunc="Search"
                                                 Placeholder="Περιοχή"
                                                 Clearable="true" />                                    <br />
                                    <MudText Typo="Typo.button">Διεύθυνση</MudText>
                                    <MudTextField Variant="Variant.Text" Placeholder="Διεύθυνση" @bind-Value="model.Address" />

                            </MudPaper>
                        </MudStep>
                        <MudStep Title="Πληροφορίες Ακινήτου" SecondaryText="Τιμή, Εμβαδόν, Όροφος" Skippable="false" CompletedChanged="@(()=> progress = 60)">
                            <MudPaper Class="pa-4">
                                    <MudText Typo="Typo.button">Τίτλος Ακινήτου</MudText>
                                    <MudTextField Variant="Variant.Text" Placeholder="Τίτλος" Required="true" RequiredError="Ο τίτλος ακινήτου είναι υποχρεωτικός" @bind-Value="model.Name" />
                                    <br />
                                    <MudText Typo="Typo.button">@priceLabel</MudText>
                                    <MudNumericField Variant="Variant.Text" Placeholder="@priceLabel" @bind-Value="model.Price" />
                                    <br />
                                    <MudText Typo="Typo.button">Εμβαδόν Ακινήτου</MudText>
                                    <MudNumericField Variant="Variant.Text" Placeholder="τ.μ" @bind-Value="model.FloorArea" />
                                    <br />
                                    <MudText Typo="Typo.button">Όροφος</MudText>
                                    <MudNumericField Variant="Variant.Text" @bind-Value="model.Floor" />
                                    <br />
                                    <MudText Typo="Typo.button">Υπνοδωμάτια</MudText>
                                    <MudNumericField Variant="Variant.Text" @bind-Value="model.Rooms" />
                                    <br />
                                    <MudText Typo="Typo.button">Έτος Κατασκευής</MudText>
                                    <MudNumericField Variant="Variant.Text" @bind-Value="model.ConstructionYear" />


                                    <MudText Typo="Typo.button">Περιγραφή Ακινήτου</MudText>
                                    <MudTextField Lines="5" AutoGrow="true" Variant="Variant.Outlined" @bind-Value="model.Description"/>
                            </MudPaper>
                        </MudStep>
                        <MudStep Title="Πληροφορίες Ιδιοκτήτη" SecondaryText="Στοιχεία επικοινωνίας" Skippable="false" CompletedChanged="@(()=> progress = 80)">
                            <MudPaper Class="pa-4">
                                    <MudText Typo="Typo.button">Ονοματεπώνυμο</MudText>
                                    <MudTextField Variant="Variant.Text" Placeholder="Ονοματεπώνυμο" @bind-Value="listing.Name" />
                                    <br />
                                    <MudText Typo="Typo.button">Τηλέφωνο</MudText>
                                    <MudTextField Variant="Variant.Text" InputMode="InputMode.tel" Placeholder="Τηλέφωνο" @bind-Value="listing.Phone" />
                                    <br />
                                    <MudText Typo="Typo.button">Email</MudText>
                                    <MudTextField Variant="Variant.Text" InputMode="InputMode.email" Placeholder="Email" @bind-Value="listing.Email" />
                            </MudPaper>
                        </MudStep>
                        <MudStep Title="Εικόνες" Skippable="false" CompletedChanged="@(()=> progress = 100)">
                                <MudFileUpload @ref="_fileUpload" T="IReadOnlyList<IBrowserFile>" OnFilesChanged="UploadFiles" AppendMultipleFiles="true">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Filled"
                                    Color="Color.Primary"
                                    StartIcon="@Icons.Material.Filled.CloudUpload">
                                        Upload Files
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                            <MudPaper Class="pa-4">                        

                                @if (filenames != null)
                                {
                                    <MudList T="string">
                                        @foreach (var file in filenames)
                                        {
                                            <MudListItem Icon="@Icons.Material.Filled.AttachFile" @key="@file">
                                                @file
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                               Color="Color.Error"
                                                               Size="Size.Small"
                                                               OnClick="@(() => DeleteFile(file))" />
                                            </MudListItem>
                                        }
                                    </MudList>
                                }


                            </MudPaper>
                        </MudStep>
                        <MudStep Title="Ολοκλήρωση Αγγελίας" Skippable="false">
                            <MudPaper Class="pa-4">
                                <MudText Typo="Typo.h6">Ολοκληρώστε την αγγελίας σας</MudText>
                            </MudPaper>
                        </MudStep>
                    </ChildContent>
                    <ActionContent Context="stepper">
                        <MudButton OnClick="@(() => stepper.ResetAsync())">Reset</MudButton>
                        @if (!_completed)
                        {
                            <MudIconButton OnClick="@(() => stepper.PreviousStepAsync())" Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary"/>
                            <MudSpacer /> 
                            @if(_index < 5)
                            {
                                <MudIconButton OnClick="@(() => stepper.NextStepAsync())" Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Primary" />
                            }                        
                            else
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleValidSubmit">Υποβολή</MudButton>                        
                            }
                        }
                    </ActionContent>
                </MudStepper>
            </MudPaper>
        </MudItem>      
    </MudGrid>
</MudForm>


                                <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="3" Class="pa-4" Style="height: 85vh; display: flex; flex-direction: column;">

        <!-- Header -->
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.h5">Virtual Assistant</MudText>
            </MudStack>

            <MudStack Row="true" Spacing="2">
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               Variant="Variant.Outlined"
                               Size="Size.Small"
                               OnClick="ClearChat"
                               Title="Clear Chat" />

                @if (_isLoading)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Stop"
                                   Color="Color.Warning"
                                   Variant="Variant.Filled"
                                   Size="Size.Small"
                                   OnClick="StopGeneration"
                                   Title="Stop Generation" />
                }
            </MudStack>
        </MudStack>

        <MudDivider Class="mb-4" />

        <!-- Messages -->
        <MudPaper id="messages-container"
                  Elevation="0"
                  Class="flex-grow-1 overflow-y-auto mb-4 pa-3"
                  Style="background-color:#f5f5f5;">

            @if (_messages.Count == 0)
            {
                <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Style="height:100%;">
                    <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">Start a conversation</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Ask me anything!</MudText>
                </MudStack>
            }
            else
            {
                @foreach (var message in _messages)
                {
                    <div style="display:flex; justify-content:@(message.IsUser ? "flex-end" : "flex-start"); margin-bottom:16px; align-items:flex-start;">

                        @if (!message.IsUser)
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-2" Style="flex-shrink:0;">
                                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="Size.Small" />
                            </MudAvatar>
                        }

                        <MudPaper Elevation="1"
                                  Class="pa-3"
                                  Style="max-width:75%; border-radius:12px;">

                            <MudText Typo="Typo.body1" Style="white-space:pre-wrap; word-wrap:break-word; line-height:1.6;">
                                @message.Text
                            </MudText>

                            @if (!message.IsUser && message.IsStreaming)
                            {
                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-2" Size="Size.Small" />
                            }

                            @if (!string.IsNullOrEmpty(message.Sources))
                            {
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.caption" Style="color:#666;">
                                    <MudIcon Icon="@Icons.Material.Filled.Source" Size="Size.Small" Style="vertical-align:middle;" />
                                    Sources: @message.Sources
                                </MudText>
                            }

                            <MudText Typo="Typo.caption"
                                     Style="@(message.IsUser ? "color:rgba(255,255,255,0.8);" : "color:#999;")"
                                     Class="mt-2">
                                @message.Timestamp.ToString("HH:mm")
                            </MudText>
                        </MudPaper>

                        @if (message.IsUser)
                        {
                            <MudAvatar Color="Color.Secondary" Size="Size.Small" Class="ml-2" Style="flex-shrink:0;">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                            </MudAvatar>
                        }
                    </div>
                }
            }
        </MudPaper>

        <!-- Input field -->
        <MudPaper Elevation="0" Class="pa-3"
                  Style="background-color:white; border-radius:12px; border:1px solid #e0e0e0;">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">

                <MudTextField @bind-Value="_inputMessage"
                              Placeholder="Type your message..."
                              Variant="Variant.Text"
                              Lines="1"
                              MaxLines="4"
                              Disabled="_isLoading"
                              OnKeyDown="HandleKeyDown"
                              Class="flex-grow-1"
                              Immediate="true" />

                <MudIconButton Icon="@Icons.Material.Filled.Send"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               Size="Size.Large"
                               Disabled="_isLoading || string.IsNullOrWhiteSpace(_inputMessage)"
                               OnClick="SendMessage"
                               Style="border-radius:50%;" />

            </MudStack>
        </MudPaper>

        @if (_error != null)
        {
            <MudAlert Severity="Severity.Error"
                      Class="mt-2"
                      Elevation="2"
                      CloseIcon="@Icons.Material.Filled.Close"
                      CloseIconClicked="() => _error = null">
                @_error
            </MudAlert>
        }
    </MudPaper>
</MudContainer>